import streamlit as st
import pandas as pd

# --- 1. è¨­å®šé é¢åŸºæœ¬è³‡è¨Š ---
st.set_page_config(page_title="è‡ºä¸­ç¤¾å®…ç§Ÿé‡‘è©¦ç®—(2025æ–°åˆ¶)", page_icon="ğŸ ")

st.title("ğŸ  è‡ºä¸­å¸‚ç¤¾å®…åŒ…ç§Ÿä»£ç®¡333è¨ˆç•«")
st.header("æ–°ç‰ˆç§Ÿé‡‘è©•å®šè©¦ç®—ç³»çµ± (2025/12/01å•Ÿç”¨)")
st.markdown("---")

# --- 2. è¼‰å…¥æ•¸æ“š (ä¾†è‡ªæ‚¨çš„åŸå§‹è³‡æ–™) ---
# Data for Whole Floor (æ•´å±¤)
whole_floor_data = {
    'è¡Œæ”¿å€': [
        'è¥¿å±¯å€', 'åŒ—å±¯å€', 'å—å±¯å€', 'åŒ—å€', 'è¥¿å€', 'ä¸­å€', 'æ±å€', 'çƒæ—¥å€', 'å—å€',
        'å¤§é‡Œå€', 'å¤ªå¹³å€', 'æ½­å­å€', 'è±åŸå€', 'åé‡Œå€', 'æ²™é¹¿å€', 'é¾äº•å€',
        'å¤§è‚šå€', 'å¤§é›…å€', 'ç¥å²¡å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€',
        'å¤–åŸ”å€', 'éœ§å³°å€', 'çŸ³å²¡å€', 'æ±å‹¢å€', 'æ–°ç¤¾å€', 'å…¶ä»–'
    ],
    '0-5å¹´': [940, 900, 900, 890, 890, 830, 830, 830, 780, 770, 770, 770, 770, 675, 675, 675, 660, 660, 660, 600, 580, 565, 505, 505, 495, 460, 445, 375],
    '5-10å¹´': [925, 885, 885, 875, 875, 815, 815, 815, 770, 760, 760, 760, 760, 665, 665, 665, 650, 650, 650, 590, 570, 555, 500, 500, 485, 450, 440, 370],
    '10-15å¹´': [905, 870, 870, 860, 860, 805, 805, 805, 755, 745, 745, 745, 745, 650, 650, 650, 640, 640, 640, 580, 560, 550, 490, 490, 480, 445, 430, 360],
    '15-20å¹´': [885, 850, 850, 840, 840, 780, 780, 780, 735, 725, 725, 725, 725, 635, 635, 635, 625, 625, 625, 565, 545, 535, 475, 475, 465, 430, 420, 355],
    '20-25å¹´': [860, 830, 830, 815, 815, 760, 760, 760, 720, 705, 705, 705, 705, 620, 620, 620, 605, 605, 605, 550, 530, 520, 465, 465, 455, 420, 410, 345],
    '25-30å¹´': [835, 805, 805, 795, 795, 740, 740, 740, 700, 685, 685, 685, 685, 600, 600, 600, 590, 590, 590, 535, 515, 505, 450, 450, 440, 410, 400, 335],
    '30-35å¹´': [815, 780, 780, 770, 770, 720, 720, 720, 680, 670, 670, 670, 670, 585, 585, 585, 575, 575, 575, 520, 500, 490, 440, 440, 430, 400, 385, 325],
    '35-40å¹´': [780, 750, 750, 740, 740, 690, 690, 690, 650, 640, 640, 640, 640, 560, 560, 560, 550, 550, 550, 500, 480, 470, 420, 420, 410, 380, 370, 310],
    '40å¹´ä»¥ä¸Š': [745, 715, 715, 705, 705, 660, 660, 660, 620, 610, 610, 610, 610, 535, 535, 535, 525, 525, 525, 475, 460, 450, 400, 400, 390, 365, 355, 295]
}
df_whole = pd.DataFrame(whole_floor_data)

# Data for Independent Studio (ç¨ç«‹å¥—æˆ¿)
studio_data = {
    'è¡Œæ”¿å€': [
        'è¥¿å±¯å€', 'åŒ—å±¯å€', 'å—å±¯å€', 'åŒ—å€', 'è¥¿å€', 'ä¸­å€', 'æ±å€', 'å—å€', 'çƒæ—¥å€',
        'å¤§é›…å€', 'æ½­å­å€', 'å¤§é‡Œå€', 'å¤ªå¹³å€', 'æ²™é¹¿å€', 'åé‡Œå€', 'å¤§è‚šå€', 'ç¥å²¡å€',
        'è±åŸå€', 'æ¢§æ£²å€', 'é¾äº•å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'çŸ³å²¡å€', 'éœ§å³°å€',
        'æ¸…æ°´å€', 'æ–°ç¤¾å€', 'æ±å‹¢å€', 'å…¶ä»–'
    ],
    '0-5å¹´': [1120, 1060, 1060, 1045, 1045, 1010, 1010, 985, 940, 915, 915, 890, 890, 890, 855, 840, 840, 840, 830, 830, 780, 720, 720, 720, 590, 480, 480, 385],
    '5-10å¹´': [1100, 1040, 1040, 1030, 1030, 995, 995, 970, 925, 900, 900, 875, 875, 875, 840, 830, 830, 830, 815, 815, 770, 710, 710, 710, 580, 475, 475, 380],
    '10-15å¹´': [1080, 1025, 1025, 1010, 1010, 975, 975, 955, 905, 885, 885, 860, 860, 860, 825, 815, 815, 815, 805, 805, 755, 700, 700, 700, 570, 465, 465, 375],
    '15-20å¹´': [1055, 995, 995, 985, 985, 950, 950, 930, 885, 860, 860, 840, 840, 840, 805, 795, 795, 795, 780, 780, 735, 680, 680, 680, 555, 455, 455, 365],
    '20-25å¹´': [1025, 970, 970, 960, 960, 925, 925, 905, 860, 840, 840, 815, 815, 815, 785, 775, 775, 775, 760, 760, 720, 660, 660, 660, 540, 445, 445, 355],
    '25-30å¹´': [1000, 945, 945, 935, 935, 900, 900, 880, 835, 815, 815, 795, 795, 795, 760, 750, 750, 750, 740, 740, 700, 645, 645, 645, 525, 430, 430, 345],
    '30-35å¹´': [970, 920, 920, 905, 905, 875, 875, 855, 815, 795, 795, 770, 770, 770, 740, 730, 730, 730, 720, 720, 680, 625, 625, 625, 510, 420, 420, 335],
    '35-40å¹´': [930, 880, 880, 870, 870, 840, 840, 820, 780, 760, 760, 740, 740, 740, 710, 700, 700, 700, 690, 690, 650, 600, 600, 600, 490, 400, 400, 320],
    '40å¹´ä»¥ä¸Š': [885, 840, 840, 830, 830, 800, 800, 780, 745, 725, 725, 705, 705, 705, 675, 665, 665, 665, 660, 660, 620, 570, 570, 570, 470, 380, 380, 305]
}
df_studio = pd.DataFrame(studio_data)

# --- 3. å»ºç«‹è¼¸å…¥ä»‹é¢ ---
col1, col2 = st.columns(2)

with col1:
    districts = df_whole['è¡Œæ”¿å€'].tolist()
    selected_district = st.selectbox("1. é¸æ“‡è¡Œæ”¿å€", districts)
    
    house_type = st.radio("2. ç‰©ä»¶é¡å‹", ["æ•´å±¤(æˆ¶)", "ç¨ç«‹å¥—æˆ¿"], horizontal=True)
    
    ages = ['0-5å¹´', '5-10å¹´', '10-15å¹´', '15-20å¹´', '20-25å¹´', '25-30å¹´', '30-35å¹´', '35-40å¹´', '40å¹´ä»¥ä¸Š']
    selected_age = st.selectbox("3. å±‹é½¡å€é–“", ages)
    
    area = st.number_input("4. ç‰©ä»¶åªæ•¸", min_value=1.0, value=25.0, step=0.1, format="%.2f")

with col2:
    # å€ä½èˆ‡è£ä¿®é‚è¼¯
    loc_options = {"å„ªè³ªå€ä½ (+5%)": 0.05, "ä¸­ä¸Šå€ä½ (+3%)": 0.03, "ä¸­ä¸‹å€ä½ (+0%)": 0.0}
    selected_loc = st.selectbox("5. å€ä½ç­‰ç´š (äº¤é€š/ç”Ÿæ´»æ©Ÿèƒ½)", options=list(loc_options.keys()))
    loc_rate = loc_options[selected_loc]

    deco_options = {"ä¸­ç­‰è£ä¿® (+5%)": 0.05, "ç°¡æ˜“è£ä¿® (+3%)": 0.03, "ç„¡è£ä¿® (+0%)": 0.0}
    selected_deco = st.selectbox("6. è£ä¿®ç­‰ç´š (æ”¶ç´/å¤©åœ°å£)", options=list(deco_options.keys()))
    deco_rate = deco_options[selected_deco]

    # è¨­å‚™é‚è¼¯ (æ•´å±¤ä¸Šé™2000, å¥—æˆ¿ä¸Šé™1000)
    max_equip = 2000 if house_type == "æ•´å±¤(æˆ¶)" else 1000
    equip_add = st.number_input(f"7. è¨­å‚™å¤–åŠ  (æœ€é«˜ {max_equip})", min_value=0, max_value=max_equip, step=100)

# --- 4. è¨ˆç®—é‚è¼¯ ---
# é¸æ“‡å°æ‡‰çš„è³‡æ–™è¡¨
if house_type == "æ•´å±¤(æˆ¶)":
    df_active = df_whole
    limit_cap = 35000  # å°ä¸­æ•´å±¤ä¸Šé™ 
else:
    df_active = df_studio
    limit_cap = 21000  # å°ä¸­å¥—æˆ¿ä¸Šé™ 

# æŸ¥è¡¨æ‰¾å–®åƒ¹
base_price = 0
try:
    row = df_active[df_active['è¡Œæ”¿å€'] == selected_district]
    if not row.empty:
        base_price = row[selected_age].values[0]
except:
    st.error("æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªè¡Œæ”¿å€èˆ‡å±‹é½¡")

# è¨ˆç®—å…¬å¼ 
# R_max = P_ref * (1 + Loc + Deco) * Area + Equip
adjusted_price_per_ping = base_price * (1 + loc_rate + deco_rate)
rent_total = round(adjusted_price_per_ping * area + equip_add)

# --- 5. é¡¯ç¤ºçµæœ ---
st.markdown("---")
st.subheader("ğŸ“Š è©¦ç®—çµæœ")

c1, c2, c3 = st.columns(3)
with c1:
    st.metric("åŸå§‹å–®åƒ¹åƒè€ƒå€¼", f"${base_price}/åª")
with c2:
    st.metric("èª¿æ•´å¾Œå–®åƒ¹", f"${round(adjusted_price_per_ping, 2)}/åª")
with c3:
    st.metric("è¨­å‚™å¤–åŠ ", f"${equip_add}")

st.markdown("### ğŸ“ ç§Ÿé‡‘ç¸½é¡ä¸Šé™ (æœ€é«˜å¯ç”³è«‹è£œåŠ©ç§Ÿé‡‘)")

# åˆ¤æ–·æ˜¯å¦è¶…éä¸Šé™
if rent_total <= limit_cap:
    st.success(f"## NT$ {rent_total:,} å…ƒ")
    st.info(f"âœ… ç¬¦åˆè‡ºä¸­å¸‚ã€{house_type}ã€‘æ”¶ä»¶ä¸Šé™ ({limit_cap:,}å…ƒ)")
else:
    st.error(f"## NT$ {rent_total:,} å…ƒ")
    st.warning(f"âš ï¸ è¶…éè‡ºä¸­å¸‚ã€{house_type}ã€‘æ”¶ä»¶ä¸Šé™ ({limit_cap:,}å…ƒ)ï¼Œè«‹ä»¥ {limit_cap:,} å…ƒç‚ºç°½ç´„ç§Ÿé‡‘ä¸Šé™ã€‚")

# è©³ç´°è¨ˆç®—éç¨‹
with st.expander("æŸ¥çœ‹è©³ç´°è¨ˆç®—å…¬å¼"):
    st.latex(r"R_{max} = P_{ref} \times (1 + \delta_{L} + \delta_{D}) \times A_{area} + \Delta_{E}")
    st.write(f"1. åƒè€ƒå–®åƒ¹ (P_ref): {base_price}")
    st.write(f"2. åŠ æˆä¿‚æ•¸: 1 + {loc_rate}(å€ä½) + {deco_rate}(è£ä¿®) = {1 + loc_rate + deco_rate}")
    st.write(f"3. èª¿æ•´å¾Œå–®åƒ¹: {base_price} * {1 + loc_rate + deco_rate} = {round(adjusted_price_per_ping, 4)}")
    st.write(f"4. ä¹˜ä¸Šåªæ•¸: {round(adjusted_price_per_ping, 4)} * {area} = {round(adjusted_price_per_ping * area)}")
    st.write(f"5. åŠ ä¸Šè¨­å‚™: + {equip_add}")
    st.write(f"6. ç¸½è¨ˆ: {rent_total}")